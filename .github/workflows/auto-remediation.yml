name: Auto-Remediation for Security Policies

on:
  # Run after successful policy deployment
  workflow_run:
    workflows: ["EPAC Tenant Workflow"]
    types:
      - completed
    branches:
      - main

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to remediate'
        required: true
        default: 'TENANT-DEPLOY-POLICY'
        type: choice
        options:
          - TENANT-DEPLOY-POLICY
          - EPAC-DEV

      scope:
        description: 'Scope for remediation (management group or subscription ID)'
        required: false
        default: '11111111111111111111111111111111111111111'

permissions:
  contents: read
  id-token: write

jobs:
  check-compliance:
    # Only run if EPAC workflow succeeded, or if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'TENANT-DEPLOY-POLICY' }}
    outputs:
      non_compliant_count: ${{ steps.check.outputs.non_compliant_count }}
      should_remediate: ${{ steps.check.outputs.should_remediate }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Check Compliance State
        id: check
        run: |
          # Get non-compliant resources count
          NON_COMPLIANT=$(az policy state list \
            --management-group "${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
            --filter "complianceState eq 'NonCompliant'" \
            --query "length(@)" -o tsv)

          echo "non_compliant_count=$NON_COMPLIANT" >> $GITHUB_OUTPUT

          # Only remediate if there are non-compliant resources
          if [ "$NON_COMPLIANT" -gt 0 ]; then
            echo "should_remediate=true" >> $GITHUB_OUTPUT
            echo "Found $NON_COMPLIANT non-compliant resources"
          else
            echo "should_remediate=false" >> $GITHUB_OUTPUT
            echo "No non-compliant resources found"
          fi

  create-remediation-tasks:
    needs: check-compliance
    if: needs.check-compliance.outputs.should_remediate == 'true'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'TENANT-DEPLOY-POLICY' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Create Remediation Tasks
        run: |
          # Get all policy assignment IDs for enforcement frameworks
          # Includes: NIST 800-53, MCSB (Microsoft Cloud Security Benchmark), and custom policies
          ASSIGNMENT_IDS=$(az policy assignment list \
            --scope "/providers/Microsoft.Management/managementGroups/${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
            --query "[?contains(displayName, 'NIST') || contains(displayName, 'Microsoft cloud security benchmark') || contains(displayName, 'MCSB')].{id:id,policyDefinitionId:policyDefinitionId}" -o json)

          if [ -z "$ASSIGNMENT_IDS" ] || [ "$ASSIGNMENT_IDS" == "[]" ]; then
            echo "Error: No enforcement policy assignments found (NIST, MCSB)"
            exit 1
          fi

          echo "Found enforcement policy assignments (NIST, MCSB):"
          echo "$ASSIGNMENT_IDS" | jq -r '.[].id'

          # Process each assignment
          echo "$ASSIGNMENT_IDS" | jq -c '.[]' | while read -r assignment; do
            ASSIGNMENT_ID=$(echo "$assignment" | jq -r '.id')
            POLICY_DEF_ID=$(echo "$assignment" | jq -r '.policyDefinitionId')
            ASSIGNMENT_NAME=$(basename "$ASSIGNMENT_ID")

            echo ""
            echo "Processing assignment: $ASSIGNMENT_NAME"
            echo "Assignment ID: $ASSIGNMENT_ID"
            echo "Policy Definition ID: $POLICY_DEF_ID"

            # Check if this is a policy set (initiative) by checking if it contains '/policySetDefinitions/'
            if [[ "$POLICY_DEF_ID" == *"/policySetDefinitions/"* ]]; then
              echo "This is a policy set - getting individual policy definitions with DeployIfNotExists/Modify effects..."

              # Extract policy set name from the full resource ID
              POLICY_SET_NAME=$(basename "$POLICY_DEF_ID")
              echo "Policy Set Name: $POLICY_SET_NAME"

              # Get the policy set definition - use different parameters for custom vs built-in policy sets
              if [[ "$POLICY_DEF_ID" == *"/managementGroups/"* ]]; then
                echo "This is a custom (management group) policy set"
                POLICY_SET=$(az policy set-definition show \
                  --management-group "${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
                  --name "$POLICY_SET_NAME" 2>/dev/null || echo "{}")
              else
                echo "This is a built-in policy set"
                POLICY_SET=$(az policy set-definition show --name "$POLICY_SET_NAME" 2>/dev/null || echo "{}")
              fi

              # Extract policy reference IDs for policies that can be remediated
              # Note: We'll attempt remediation for all policies in the set since we can't easily determine effect from here
              POLICY_REF_IDS=$(echo "$POLICY_SET" | jq -r '.policyDefinitions[]? | .policyDefinitionReferenceId' 2>/dev/null || echo "")

              if [ -n "$POLICY_REF_IDS" ]; then
                echo "Found policy reference IDs in set:"
                echo "$POLICY_REF_IDS"

                # Create remediation task for each policy in the set
                for REF_ID in $POLICY_REF_IDS; do
                  TASK_NAME="NIST-Remediation-${REF_ID}-$(date +%Y%m%d-%H%M%S)"
                  echo "Creating remediation for policy: $REF_ID"

                  az policy remediation create \
                    --name "$TASK_NAME" \
                    --policy-assignment "$ASSIGNMENT_ID" \
                    --definition-reference-id "$REF_ID" \
                    --management-group "${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
                    2>&1 || echo "âš ï¸  Remediation not applicable for $REF_ID (may be Audit/Deny effect)"

                  # Small delay to avoid rate limiting
                  sleep 1
                done
              else
                echo "âš ï¸  Could not retrieve policy definitions from policy set"
              fi
            else
              echo "This is a single policy definition - creating direct remediation..."
              TASK_NAME="NIST-Remediation-$(date +%Y%m%d-%H%M%S)"

              az policy remediation create \
                --name "$TASK_NAME" \
                --policy-assignment "$ASSIGNMENT_ID" \
                --management-group "${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
                2>&1 || echo "âš ï¸  Remediation not applicable"
            fi

            echo "âœ… Remediation tasks created for: $ASSIGNMENT_NAME"
          done

      - name: List Remediation Tasks
        run: |
          echo "Listing all remediation tasks (NIST, MCSB)..."
          az policy remediation list \
            --management-group "${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
            --query "[?contains(name, 'NIST-Remediation') || contains(name, 'MCSB-Remediation')].{Name:name, State:provisioningState, TotalDeployments:deploymentStatus.totalDeployments, SuccessfulDeployments:deploymentStatus.successfulDeployments, FailedDeployments:deploymentStatus.failedDeployments}" \
            -o table

  generate-report:
    needs: [check-compliance, create-remediation-tasks]
    if: always()
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'TENANT-DEPLOY-POLICY' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Generate Compliance Report
        run: |
          # Generate a detailed compliance report for all enforcement frameworks
          REPORT_FILE="compliance-report-$(date +%Y%m%d-%H%M%S).md"

          echo "# Security Policy Compliance Report" > $REPORT_FILE
          echo "Frameworks: NIST 800-53, Microsoft Cloud Security Benchmark (MCSB)" >> $REPORT_FILE
          echo "Generated: $(date)" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # Get overall compliance
          echo "## Overall Compliance" >> $REPORT_FILE
          az policy state summarize \
            --management-group "${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
            -o table >> $REPORT_FILE

          # Get non-compliant resources
          echo "" >> $REPORT_FILE
          echo "## Non-Compliant Resources" >> $REPORT_FILE
          az policy state list \
            --management-group "${{ github.event.inputs.scope || '11111111111111111111111111111111111111111' }}" \
            --filter "complianceState eq 'NonCompliant'" \
            --query "[].{Resource:resourceId, Policy:policyDefinitionName, Action:policyDefinitionAction}" \
            -o table >> $REPORT_FILE

          # Upload report as artifact
          echo "Report generated: $REPORT_FILE"

      - name: Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report-*.md
          retention-days: 30

  notify:
    needs: [check-compliance, create-remediation-tasks, generate-report]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Send Notification
        run: |
          # Create summary for GitHub Actions
          echo "# Security Policy Auto-Remediation Summary" >> $GITHUB_STEP_SUMMARY
          echo "Frameworks: NIST 800-53 & Microsoft Cloud Security Benchmark (MCSB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-compliance.outputs.should_remediate }}" == "true" ]; then
            echo "âœ… **Remediation Triggered**" >> $GITHUB_STEP_SUMMARY
            echo "- Non-compliant resources found: ${{ needs.check-compliance.outputs.non_compliant_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Remediation tasks created for NIST and MCSB policies" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ¨ **No Remediation Needed**" >> $GITHUB_STEP_SUMMARY
            echo "- All resources are compliant with NIST and MCSB" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the compliance report in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Azure Portal for detailed remediation results" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor resource compliance over time" >> $GITHUB_STEP_SUMMARY